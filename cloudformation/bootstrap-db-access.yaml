---

# This template is to be executed in the account which holds the certsquirt DB, to allow
# access from another account.  You will need to create the user first using the 
# `bootstrap-user.yaml' template.

AWSTemplateFormatVersion: "2010-09-09"
Transform: "AWS::Serverless-2016-10-31"
Description: |
  This cfn-template allows access to the CertSquirt DB for use by a user in another account.

Parameters:
  BuTag:
    Type: String
    Description: The BU tag used for cost allocation
    Default: IT

  EnvironmentTag:
    Type: String
    Description: The Environment tag used for cost allocation
    Default: Production

  RemoteUser:
    Type: String
    Description:  The ARN of another user, in another account, to access the certsquirt DB.
    Default: arn:aws:iam::658786808637:user/ocsp-user-OcspUser-1PSF2LX38D0KO


Resources:

  OcspDynamoDbAccessRole:
    Type: AWS::IAM::Role
    Properties:
      Description: Allows access to CertSquirt DynamoDB table
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal: 
              AWS: 
                - !Ref RemoteUser
      Path: /
      Policies:
        - PolicyName: OcspAccessPolicy
          PolicyDocument: 
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Sid: OcspDbAccess
                Action:
                  - dynamodb:GetItem
                  - dynamodb:BatchGetItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:ConditionCheckItem
                  - dynamodb:DescribeTable
                Resource:
                  - !ImportValue CertSquirtTableArn

Outputs:
  OcspAccessRole:
    Value: !GetAtt OcspDynamoDbAccessRole.Arn
    Export:
      Name: OcspAccessRole  
